<section class="pdp section-padding">
  <div class="pdp__inner">
    <div class="pdp__gallery">
      {% for image in product.images %}
        <div class="pdp__image-wrap">
          <img
            src="{{ image | image_url: width: 900 }}"
            srcset="{{ image | image_url: width: 600 }} 600w, {{ image | image_url: width: 900 }} 900w, {{ image | image_url: width: 1200 }} 1200w"
            sizes="(max-width: 749px) 100vw, 50vw"
            alt="{{ image.alt | default: product.title }}"
            loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
            width="900"
            height="{{ 900 | divided_by: image.aspect_ratio | round }}"
            class="pdp__image"
          >
        </div>
      {% endfor %}
    </div>

    <div class="pdp__info">
      <div class="pdp__header">
        {% if product.vendor != blank %}
          <p class="pdp__vendor text-muted text-upper text-spacing">{{ product.vendor }}</p>
        {% endif %}
        <h1 class="pdp__title">{{ product.title }}</h1>
        <p class="pdp__price">{{ product.price | money }}</p>

        {% assign retail_value = product.metafields.custom.retail_value %}
        {% if retail_value != blank and product.tags contains 'for-rent' %}
          <p class="pdp__savings text-muted">
            RRP: {{ retail_value | money }} — You save {{ retail_value | minus: product.price | money }}
          </p>
        {% endif %}
      </div>

      <div class="pdp__form" id="flexcon-target">
        {% form 'product', product %}
          {% assign current_variant = product.selected_or_first_available_variant %}

          {% if product.has_only_default_variant == false %}
            <div class="pdp__variants">
              {% for option in product.options_with_values %}
                <div class="pdp__option">
                  <label class="pdp__option-label text-upper text-spacing">{{ option.name }}</label>
                  <div class="pdp__option-values">
                    {% for value in option.values %}
                      <button
                        type="button"
                        class="pdp__size-btn {% if option.selected_value == value %}pdp__size-btn--active{% endif %}"
                        data-option-index="{{ forloop.parentloop.index0 }}"
                        data-value="{{ value }}"
                      >
                        {{ value }}
                      </button>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <select name="id" class="visually-hidden" aria-label="Variant">
            {% for variant in product.variants %}
              <option
                value="{{ variant.id }}"
                {% if variant == current_variant %}selected{% endif %}
                {% unless variant.available %}disabled{% endunless %}
              >
                {{ variant.title }} — {{ variant.price | money }}
              </option>
            {% endfor %}
          </select>

          <input type="hidden" name="quantity" value="1">

          {% if product.tags contains 'for-rent' %}
            <button type="submit" class="btn btn--primary pdp__cta">Book This Look</button>
          {% else %}
            <button type="submit" class="btn btn--primary pdp__cta">Add to Cart</button>
          {% endif %}
        {% endform %}
      </div>

      {% if product.description != blank %}
        <div class="pdp__description">
          <details open>
            <summary class="pdp__accordion-title text-upper text-spacing">Details</summary>
            <div class="pdp__accordion-content">{{ product.description }}</div>
          </details>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
  (function() {
    var buttons = document.querySelectorAll('.pdp__size-btn');
    var select = document.querySelector('.pdp__form select[name="id"]');
    if (!buttons.length || !select) return;

    var product = {{ product | json }};

    buttons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var group = btn.closest('.pdp__option');
        group.querySelectorAll('.pdp__size-btn').forEach(function(b) {
          b.classList.remove('pdp__size-btn--active');
        });
        btn.classList.add('pdp__size-btn--active');

        var selected = [];
        document.querySelectorAll('.pdp__option').forEach(function(opt) {
          var active = opt.querySelector('.pdp__size-btn--active');
          if (active) selected.push(active.dataset.value);
        });

        var match = product.variants.find(function(v) {
          return selected.every(function(val, i) {
            return v.options[i] === val;
          });
        });

        if (match) select.value = match.id;
      });
    });
  })();
</script>

{% stylesheet %}
  .pdp__inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
    align-items: start;
  }

  .pdp__gallery {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .pdp__image-wrap {
    aspect-ratio: 3 / 4;
    overflow: hidden;
    background-color: var(--color-bg-alt);
  }

  .pdp__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .pdp__info {
    position: sticky;
    top: 6rem;
  }

  .pdp__vendor {
    font-size: var(--text-xs);
    margin-bottom: var(--space-xs);
  }

  .pdp__title {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-sm);
  }

  .pdp__price {
    font-size: var(--text-lg);
    font-weight: 400;
  }

  .pdp__savings {
    font-size: var(--text-sm);
    margin-top: var(--space-xs);
  }

  .pdp__form {
    margin-top: var(--space-lg);
  }

  .pdp__variants {
    margin-bottom: var(--space-md);
  }

  .pdp__option {
    margin-bottom: var(--space-sm);
  }

  .pdp__option-label {
    display: block;
    font-size: var(--text-xs);
    margin-bottom: var(--space-xs);
  }

  .pdp__option-values {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .pdp__size-btn {
    min-width: 3rem;
    padding: 0.5rem 1rem;
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    background: transparent;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .pdp__size-btn:hover {
    border-color: var(--color-fg);
  }

  .pdp__size-btn--active {
    border-color: var(--color-fg);
    background-color: var(--color-fg);
    color: var(--color-bg);
  }

  .pdp__cta {
    width: 100%;
    padding: 1rem 2rem;
    font-size: var(--text-sm);
  }

  .pdp__description {
    margin-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  .pdp__accordion-title {
    font-size: var(--text-xs);
    padding: var(--space-md) 0;
    cursor: pointer;
    list-style: none;
  }
  .pdp__accordion-title::-webkit-details-marker { display: none; }

  .pdp__accordion-content {
    padding-bottom: var(--space-md);
    font-size: var(--text-sm);
    line-height: 1.7;
    color: var(--color-fg-muted);
  }

  @media (max-width: 749px) {
    .pdp__inner {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
    .pdp__info { position: static; }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Page",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
